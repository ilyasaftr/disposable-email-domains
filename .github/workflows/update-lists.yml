name: Update Lists

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  execute:
    name: Update Allow and Deny Lists
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 'stable'
          cache: true

      - name: Generate lists
        run: |
          go run . \
            --out-text-deny lists/deny.txt \
            --out-json-deny lists/deny.json \
            --out-text-allow lists/allow.txt \
            --out-json-allow lists/allow.json

      - name: Detect changes in lists
        id: detect
        run: |
          set -euo pipefail
          git add lists/
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update README stats
        if: steps.detect.outputs.changed == 'true'
        run: |
          set -euo pipefail
          deny=$(wc -l < lists/deny.txt)
          allow=$(wc -l < lists/allow.txt)
          total=$((deny + allow))
          ts=$(date -u '+%Y-%m-%d %H:%M UTC')
          awk -v deny="$deny" -v allow="$allow" -v total="$total" -v ts="$ts" '
            BEGIN { start="<!-- STATS:START -->"; endm="<!-- STATS:END -->" }
            {
              if ($0==start) { print start; print "- Deny: "deny; print "- Allow: "allow; print "- Total: "total; print "- Last updated: "ts; inside=1; next }
              if ($0==endm)  { print endm; inside=0; next }
              if (!inside) print
            }
          ' README.md > README.md.tmp && mv README.md.tmp README.md

          echo "### Lists Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Deny entries: $(wc -l < lists/deny.txt)" >> $GITHUB_STEP_SUMMARY
          echo "- Allow entries: $(wc -l < lists/allow.txt)" >> $GITHUB_STEP_SUMMARY

      - name: Commit and push changes
        if: steps.detect.outputs.changed == 'true'
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail
          git add lists/ README.md
          git commit -m "chore: automatic list update"
          git push

      - name: Purge jsDelivr CDN
        if: steps.detect.outputs.changed == 'true'
        run: |
          set -euo pipefail
          REF="${GITHUB_REF_NAME:-main}"
          BASE="https://cdn.jsdelivr.net/gh/${GITHUB_REPOSITORY}@${REF}/lists"
          PURGE_BASE="https://purge.jsdelivr.net/gh/${GITHUB_REPOSITORY}@${REF}/lists"
          for f in deny.txt deny.json allow.txt allow.json; do
            echo "Purging jsDelivr cache for $f"
            # Hit the CDN URL (warming) and then request purge
            curl -fsS "$BASE/$f" >/dev/null || true
            curl -fsS "$PURGE_BASE/$f" >/dev/null || echo "Purge request failed for $f" >&2
          done
